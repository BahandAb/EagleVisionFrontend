<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EagleVision Workspace</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Socket.IO for signaling -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- LiveKit Client (v1.15.4 - confirmed working) -->
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@1.15.4/dist/livekit-client.umd.min.js"></script>
    
    <!-- OpenCV (async, loads in background) -->
    <script src="https://docs.opencv.org/4.5.4/opencv.js" async></script> 
    
    <!-- Image processor helper -->
    <script src="img_processor.js"></script> 
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>

    <div class="top-header">
        <div class="header-left">
            <span class="brand-title">EagleVision</span>
        </div>
        <div class="header-right">
            <span id="displaySessionCode" class="session-code">...</span>
            <div id="statusTag" class="tag-live" style="display: none;">● LIVE</div>
            <button class="btn-leave" onclick="leaveSession()">EXIT</button>
        </div>
    </div>

    <div class="main-layout">
        
        <div class="activity-bar">
            <div class="activity-icon active" onclick="togglePanel('tools')" title="Tools">
                <span class="material-icons">brush</span>
            </div>
            <div class="activity-icon" onclick="togglePanel('adjustments')" title="Image Adjustments">
                <span class="material-icons">tune</span>
            </div>
            <div class="activity-icon" onclick="togglePanel('gallery')" title="Gallery">
                <span class="material-icons">photo_library</span>
            </div>
            <div class="activity-icon" onclick="togglePanel('people')" title="Roster">
                <span class="material-icons">group</span>
            </div>
            <div class="activity-icon" onclick="togglePanel('settings')" title="Settings">
                <span class="material-icons">settings</span>
            </div>
            <div style="flex:1"></div>
            <div class="activity-icon" onclick="togglePanel('code')" title="Developer Mode">
                <span class="material-icons">code</span>
            </div>
        </div>

        <div id="sidePanel" class="side-panel">
            
            <div id="panel-tools" class="panel-content active">
                <div class="panel-header">Annotation Tools</div>
                
                <div class="control-group">
                    <label>Draw Color</label>
                    <div class="color-picker-row">
                        <div class="color-swatch active" style="background: #FFD700;" onclick="setColor('#FFD700', this)"></div>
                        <div class="color-swatch" style="background: #FF4444;" onclick="setColor('#FF4444', this)"></div>
                        <div class="color-swatch" style="background: #44FF44;" onclick="setColor('#44FF44', this)"></div>
                        <div class="color-swatch" style="background: #44FFFF;" onclick="setColor('#44FFFF', this)"></div>
                        <div class="color-swatch" style="background: #FFFFFF;" onclick="setColor('#FFFFFF', this)"></div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Stroke Thickness</label>
                    <div class="thickness-row">
                        <div class="thickness-btn active" onclick="setThickness(2, this)">
                            <div class="dot-preview" style="width: 2px; height: 2px;"></div>
                        </div>
                        <div class="thickness-btn" onclick="setThickness(6, this)">
                            <div class="dot-preview" style="width: 6px; height: 6px;"></div>
                        </div>
                        <div class="thickness-btn" onclick="setThickness(12, this)">
                            <div class="dot-preview" style="width: 12px; height: 12px;"></div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Actions</label>
                    <button class="btn-leave" style="width: 100%; margin-bottom: 10px;" onclick="clearAnnotations()">Clear My Screen</button>
                    <button class="btn-leave" style="width: 100%; border-color: #555;" onclick="toggleAnnotationVisibility()">Hide/Show Annotations</button>
                </div>
            </div>

            <div id="panel-adjustments" class="panel-content">
                <div class="panel-header">Feed Controls</div>
                <div class="control-group">
                    <label style="color: #ff6666;">Red Channel: <span id="val-r" style="color:white; float:right">100</span></label>
                    <input type="range" id="slider-r" min="0" max="255" value="100" oninput="updateRGB('r', this.value)">
                </div>
                <div class="control-group">
                    <label style="color: #66ff66;">Green Channel: <span id="val-g" style="color:white; float:right">100</span></label>
                    <input type="range" id="slider-g" min="0" max="255" value="100" oninput="updateRGB('g', this.value)">
                </div>
                <div class="control-group">
                    <label style="color: #66aaff;">Blue Channel: <span id="val-b" style="color:white; float:right">100</span></label>
                    <input type="range" id="slider-b" min="0" max="255" value="100" oninput="updateRGB('b', this.value)">
                </div>
                <hr style="border-color: #333; margin: 20px 0;">
                <div class="control-group">
                    <label>Brightness: <span id="val-brightness" style="color:white; float:right">100</span></label>
                    <input type="range" id="slider-brightness" min="0" max="300" value="100" oninput="updateFilter('brightness', this.value)">
                </div>
                <div class="control-group">
                    <label>Contrast: <span id="val-contrast" style="color:white; float:right">100</span></label>
                    <input type="range" id="slider-contrast" min="0" max="300" value="100" oninput="updateFilter('contrast', this.value)">
                </div>
                <div class="control-group">
                    <label>Saturation: <span id="val-saturation" style="color:white; float:right">100</span></label>
                    <input type="range" id="slider-saturation" min="0" max="300" value="100" oninput="updateFilter('saturation', this.value)">
                </div>
                <hr style="border-color: #333; margin: 20px 0;">
                <div class="control-group">
                    <label>Orientation</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn-leave" style="flex: 1;" onclick="rotateFeed()"><span class="material-icons" style="font-size: 16px;">rotate_right</span> 90°</button>
                        <button class="btn-leave" style="flex: 1;" onclick="normalizeFeed()">Normalize</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnFlipH" class="btn-leave" style="flex: 1;" onclick="toggleFlip('h')">Flip H</button>
                        <button id="btnFlipV" class="btn-leave" style="flex: 1;" onclick="toggleFlip('v')">Flip V</button>
                    </div>
                </div>
                <button class="btn-leave" style="width: 100%; border-color: #ff4444; color: #ff4444; margin-top: 10px;" onclick="resetAdjustments()">Reset All</button>
            </div>

            <div id="panel-gallery" class="panel-content">
                <div class="panel-header">Session Snapshots</div>
                <div id="galleryGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
            </div>

            <div id="panel-people" class="panel-content">
                <div class="panel-header">In Session <span id="studentCount">(0)</span></div>
                <div id="studentRosterList"></div>
            </div>

             <div id="panel-settings" class="panel-content">
                <div class="panel-header">Settings</div>
                
                <div id="adminLoginForm">
                    <div class="control-group">
                        <label>Admin Key</label>
                        <input type="text" id="adminKeyInput" placeholder="Enter Key" style="width: 100%; padding: 8px; background: #111; border: 1px solid #444; color: white;">
                        <button class="btn-leave" style="width: 100%; margin-top: 5px;" onclick="attemptAdminLogin()">Unlock Host Controls</button>
                    </div>
                </div>

                <div id="adminControlsArea" style="display: none;">
                    <div style="color:#44FF44; font-weight:bold; text-align:center; margin-bottom: 20px; border: 1px solid #44FF44; padding: 10px; border-radius: 6px;">
                        <span class="material-icons" style="vertical-align: middle;">verified</span> HOST ACCESS
                    </div>

                    <div class="control-group">
                        <label>Microscope Mode</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                            <button id="btnModeLive" class="btn-leave active" style="flex: 1; border-color: #FF4444;" onclick="triggerReturnLive()">
                                <span class="material-icons" style="font-size:16px;">videocam</span> LIVE
                            </button>
                            <button id="btnModePhoto" class="btn-leave" style="flex: 1; border-color: #44FF44;" onclick="triggerRequestPhoto()">
                                <span class="material-icons" style="font-size:16px;">image</span> 4K PHOTO
                            </button>
                        </div>
                        <small style="color:#888; display:block; margin-bottom: 15px;">
                            Use <b>4K Photo</b> for large classes (30+ students). <br>
                            Use <b>Live</b> for small groups (Max 4 students).
                        </small>
                    </div>

                    <div class="control-group">
                        <label>Classroom Management</label>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="checkFollowMode" onchange="toggleFollowMode()"> 
                                <span style="color: #FFD700">Follow Mode</span>
                            </label>
                            <small style="color:#666; display:block; margin-left:24px;">Force student view to match yours.</small>

                            <label style="margin-top: 10px;">
                                <input type="checkbox" id="checkBroadcast" onchange="toggleBroadcastMode()"> 
                                <span style="color: #FFD700">Broadcast Drawings</span>
                            </label>
                            <small style="color:#666; display:block; margin-left:24px;">Students see what you draw.</small>
                        </div>
                    </div>

                    <div class="control-group">
                        <button class="btn-leave" style="width: 100%; border-color: #FF4444; color: #FF4444;" onclick="adminClearAll()">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete_forever</span>
                            Clear ALL Screens
                        </button>
                    </div>
                </div>
            </div>

            <div id="panel-code" class="panel-content">
                <div class="panel-header">Developer Tools</div>
                <p style="font-size: 12px; color: #888;">Coming Soon: Python Overlay Engine</p>
            </div>
        </div>

        <div class="workspace-area">
            <div class="viewport-window" id="viewportContainer">
                <div class="transform-container" id="zoomLayer">
                    <video id="remoteVideo" autoplay playsinline muted></video>
                    
                    <img id="staticPhoto" style="display: none; width: 100%; height: 100%; object-fit: contain;">
                    
                    <canvas id="annotationCanvas"></canvas>
                </div>
            </div>

            <div class="toolbar-dock">
                <button class="tool-btn active" onclick="setTool('move')" id="btnToolMove" title="Move and Zoom the Image">
                    <span class="material-icons">pan_tool</span>
                </button>
                <div class="toolbar-divider"></div>
                <button class="tool-btn" onclick="setTool('draw')" id="btnToolDraw" title="Draw with Pen">
                    <span class="material-icons">brush</span>
                </button>
                <button class="tool-btn" onclick="setTool('eraser')" id="btnToolEraser" title="Erase Your Drawings">
                    <span class="material-icons">backspace</span>
                </button>
                <button class="tool-btn" onclick="setTool('text')" id="btnToolText" title="Add Text Labels">
                    <span class="material-icons">title</span>
                </button>
                <button class="tool-btn" onclick="setTool('count')" id="btnToolCount" title="Count Objects (Click to Add Numbers)">
                    <span class="material-icons">touch_app</span>
                    <div id="countBadge" class="count-badge" style="display: none;">0</div>
                </button>
                <div class="toolbar-divider"></div>
                <button class="tool-btn" onclick="toggleFreeze()" title="Pause the Video">
                    <span class="material-icons" id="iconFreeze">pause</span>
                </button>
                <button class="tool-btn" onclick="takeSnapshot()" title="Save Screenshot to Gallery">
                    <span class="material-icons" style="color: #FFD700;">camera_alt</span>
                </button>
            </div>
        </div>
    </div>

    <div id="photoModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modalImage" class="modal-img">
            <a id="modalDownload" class="btn-leave" style="text-align: center; background: var(--accent); color: black; border: none; font-weight: bold; text-decoration: none;" download="snapshot.png">DOWNLOAD PHOTO</a>
        </div>
    </div>

    <div id="textModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px; padding: 30px;">
            <h3 style="margin-top: 0; color: var(--accent);">Add Text Annotation</h3>
            <input type="text" id="textInput" placeholder="Type your text here..." 
                   style="width: 100%; padding: 15px; font-size: 18px; border: 2px solid var(--accent); 
                          border-radius: 8px; background: var(--bg-panel); color: white; margin: 20px 0;">
            <div style="display: flex; gap: 10px;">
                <button onclick="confirmTextInput()" 
                        style="flex: 1; padding: 15px; font-size: 16px; background: var(--accent); 
                               color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    ADD TEXT
                </button>
                <button onclick="cancelTextInput()" 
                        style="flex: 1; padding: 15px; font-size: 16px; background: #555; 
                               color: white; border: none; border-radius: 8px; cursor: pointer;">
                    CANCEL
                </button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>